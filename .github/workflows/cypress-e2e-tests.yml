name: Cypress E2E Tests

on:
    pull_request:
        types: [opened, synchronize, ready_for_review]
    workflow_dispatch:

jobs:
    detect_categories:
        name: Detecting E2E Test Categories
        runs-on: ubuntu-latest
        outputs:
            categories: ${{ steps.set_categories.outputs.categories }}
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Setup Node.js and install dependencies
              uses: ./.github/setup-node

            - name: List test categories
              id: set_categories
              run: |
                  categories=$(node .github/scripts/list-e2e-test-categories.js)
                  categories_json=$(echo $categories | jq -c '.')
                  echo "categories=$categories_json" >> $GITHUB_OUTPUT

            - name: Print categories output
              run: |
                  echo "Detected categories: ${{ steps.set_categories.outputs.categories }}"

    start_wp_env:
        name: Start WordPress Environment
        runs-on: ubuntu-latest
        outputs:
            wp_env_running: ${{ steps.wp_env_running.outputs.wp_env_running }}
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Setup Node.js and install dependencies
              uses: ./.github/setup-node

            - name: Install Composer Packages
              run: composer install --no-dev -o --apcu-autoloader -a

            - name: Start WordPress Environment
              id: wp_env_running
              run: npm run env:start

    cypress_e2e_tests:
        name: E2E Test
        needs:
            - detect_categories
            - start_wp_env
        runs-on: ubuntu-latest
        if: ${{ github.repository == 'blockeraai/blockera' || github.event_name == 'pull_request' }}
        strategy:
            fail-fast: false
            matrix:
                category: ${{ fromJson(needs.detect_categories.outputs.categories) }}
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Setup Node.js and install dependencies
              uses: ./.github/setup-node

            - name: Create env file
              run: |
                  touch .env
                  echo APP_MODE=production >> .env
                  echo DB=wp_tests >> .env
                  cat .env

            - name: Build wp-env app
              run: npm run build

            - name: Install Cypress
              run: npx cypress install

            - name: Debug Matrix Category
              run: |
                  echo "Running category: ${{ matrix.category }}"

            - name: Run Cypress E2E Tests
              run: npm run test:e2e -- --spec "packages/**/*.cy.e2e.${{ matrix.category }}.js"

    stop_wp_env:
        name: Stop WordPress Environment
        runs-on: ubuntu-latest
        needs: start_wp_env
        if: ${{ needs.start_wp_env.outputs.wp_env_running == 'true' }}
        steps:
            - name: Stop WordPress Environment
              run: npm run env:stop
